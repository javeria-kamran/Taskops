# Implementation Plan: Phase II Web Application

**Branch**: `002-phase2-web-app` | **Date**: December 28, 2024 | **Spec**: [overview.md](./overview.md)
**Input**: Feature specifications from `/specs/002-phase2-web-app/`

## Summary

Transform the Phase I console application into a modern multi-user web application with persistent storage and authentication. This involves building a FastAPI backend with PostgreSQL persistence, a Next.js frontend with Better Auth, and implementing all 5 Basic Level CRUD operations (Create, View, Update, Delete, Mark Complete) in a responsive web interface with JWT-based user isolation.

## Technical Context

**Language/Version**:
- Backend: Python 3.13+
- Frontend: TypeScript 5.x with Next.js 16+

**Primary Dependencies**:
- **Backend**: FastAPI 0.104+, SQLModel 0.0.14+, Alembic, Pydantic 2.5+, python-jose (JWT), passlib (password hashing), asyncpg (PostgreSQL driver)
- **Frontend**: Next.js 16+ (App Router), React 19, Better Auth 1.0+, Tailwind CSS 3.4+, TypeScript 5.x

**Storage**: Neon Serverless PostgreSQL (managed cloud database with connection pooling and automatic backups)

**Testing**:
- Backend: pytest 7.4+, pytest-cov, pytest-asyncio, httpx (API testing)
- Frontend: Jest 29+, React Testing Library, Playwright (E2E)

**Target Platform**:
- Backend: Linux server (Docker container)
- Frontend: Vercel deployment (Node.js 18+ runtime)
- Database: Neon cloud (no local PostgreSQL)

**Project Type**: Web application (client-server architecture with separate frontend/backend)

**Performance Goals**:
- API response time: <200ms p95
- Initial page load: <2 seconds
- Time to interactive: <3 seconds
- Support 100+ concurrent users

**Constraints**:
- Must use Next.js App Router (not Pages Router)
- Must use SQLModel for ORM (not raw SQLAlchemy)
- Must use Better Auth (not NextAuth/Clerk/custom)
- Must use Neon PostgreSQL (not local Postgres/SQLite)
- All code generated by Claude Code from specs
- No manual coding allowed
- User isolation enforced at database query level
- Every API request must be authenticated via JWT

**Scale/Scope**:
- Support 1000+ users
- Handle 10,000+ tasks
- 2 core features: authentication + task management
- ~20 API endpoints
- ~15 UI components
- ~30 test files

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### âœ… Spec-Driven Development First
- [x] Feature specs exist in `/specs/002-phase2-web-app/features/`
- [x] Specs include user stories and acceptance criteria (task-crud.md, authentication.md)
- [x] Technical implementation details documented (overview.md, architecture.md)
- [x] Spec reviewed and approved (by user)
- [ ] Implementation matches spec exactly (pending implementation)

### âœ… Agentic Development Workflow
- [x] Specifications written (overview.md, features/, api/, database/, ui/)
- [ ] Plan generated (this file - in progress)
- [ ] Task breakdown created (pending /speckit.tasks command)
- [ ] Implementation via Claude Code (pending)
- [ ] Validation against acceptance criteria (pending)

### âœ… Progressive Enhancement
- [x] Phase I completed (console app with 5 Basic Level features)
- [ ] Phase II in progress (web app transformation)
- [ ] All Phase I deliverables complete before starting Phase II
- [x] Phase II builds on Phase I foundation (ports business logic)

### âœ… Clean Architecture & Separation of Concerns
- [x] Monorepo structure planned (frontend/ + backend/ + src/)
- [x] Clear layer boundaries: Frontend (Next.js) â†’ Backend (FastAPI) â†’ Database (Neon)
- [x] Communication via REST API only
- [x] No cross-layer shortcuts

### âœ… Security by Design
- [x] Authentication via Better Auth specified
- [x] JWT tokens required for all API requests
- [x] User isolation enforced at database level (all queries filtered by user_id)
- [x] Password hashing handled by Better Auth (bcrypt)
- [x] SQL injection prevention via SQLModel ORM
- [x] CORS restricted to frontend origin

### âœ… Stateless & Scalable Design
- [x] Backend designed as stateless (no in-memory sessions)
- [x] All state persisted to database
- [x] Horizontal scaling capable

### âœ… Database as Single Source of Truth
- [x] Data models specified (users, tasks)
- [x] All queries filtered by user_id
- [x] Cascading deletes configured
- [x] Indexes planned for performance

### âœ… Technology Stack Mandates
- [x] Next.js 16+ (App Router) for frontend
- [x] FastAPI for backend
- [x] SQLModel for ORM
- [x] Neon Serverless PostgreSQL for database
- [x] Better Auth with JWT for authentication

### âœ… Feature Progression Framework
- [x] All 5 Basic Level features specified (Create, View, Update, Delete, Mark Complete)
- [x] No Intermediate/Advanced features in Phase II scope
- [x] Basic Level features must be complete before any extras

### âš ï¸ No Violations Requiring Justification
All constitutional principles are followed with no exceptions needed.

## Project Structure

### Documentation (this feature)

```text
specs/002-phase2-web-app/
â”œâ”€â”€ overview.md              # âœ… Project overview
â”œâ”€â”€ architecture.md          # âœ… System design
â”œâ”€â”€ plan.md                  # âœ… This file
â”œâ”€â”€ research.md              # ðŸ”„ Phase 0 output (to be created)
â”œâ”€â”€ data-model.md            # ðŸ”„ Phase 1 output (to be created)
â”œâ”€â”€ quickstart.md            # ðŸ”„ Phase 1 output (to be created)
â”œâ”€â”€ contracts/               # ðŸ”„ Phase 1 output (to be created)
â”‚   â”œâ”€â”€ rest-api.yaml        # OpenAPI spec for REST endpoints
â”‚   â””â”€â”€ database-schema.sql  # SQL DDL for database
â”œâ”€â”€ tasks.md                 # â³ Phase 2 output (/speckit.tasks - not created by this command)
â”œâ”€â”€ features/                # âœ… Feature specifications
â”‚   â”œâ”€â”€ task-crud.md
â”‚   â””â”€â”€ authentication.md
â”œâ”€â”€ api/                     # âœ… API specifications
â”‚   â””â”€â”€ rest-endpoints.md
â”œâ”€â”€ database/                # âœ… Database specifications
â”‚   â””â”€â”€ schema.md
â””â”€â”€ ui/                      # âœ… UI specifications
    â”œâ”€â”€ components.md
    â””â”€â”€ pages.md
```

### Source Code (repository root)

```text
# Phase I: Console App (Preserved)
src/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ task.py             # In-memory Task entity
â”œâ”€â”€ services/
â”‚   â””â”€â”€ task_manager.py     # Business logic (reference for Phase II)
â”œâ”€â”€ cli/
â”‚   â”œâ”€â”€ menu.py
â”‚   â””â”€â”€ handlers.py
â””â”€â”€ lib/
    â”œâ”€â”€ exceptions.py
    â””â”€â”€ validators.py

tests/                      # Phase I tests (preserved)
â”œâ”€â”€ unit/
â””â”€â”€ integration/

# Phase II: Backend (FastAPI)
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py             # FastAPI app entry point
â”‚   â”œâ”€â”€ config.py           # Environment configuration
â”‚   â”œâ”€â”€ database.py         # SQLModel database connection
â”‚   â”‚
â”‚   â”œâ”€â”€ models/             # SQLModel database entities
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ task.py         # Task model (user_id FK)
â”‚   â”‚   â””â”€â”€ user.py         # User model (Better Auth managed)
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/            # Pydantic request/response schemas
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ task.py         # TaskCreate, TaskUpdate, TaskResponse
â”‚   â”‚   â””â”€â”€ user.py         # UserCreate, UserResponse
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/             # API endpoint handlers
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ tasks.py        # CRUD endpoints for tasks
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware/         # Request/response middleware
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth.py         # JWT verification middleware
â”‚   â”‚   â””â”€â”€ cors.py         # CORS configuration
â”‚   â”‚
â”‚   â””â”€â”€ dependencies/       # Dependency injection
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ auth.py         # Auth dependency (get_current_user)
â”‚
â”œâ”€â”€ tests/                  # Backend tests
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py         # Pytest fixtures
â”‚   â”œâ”€â”€ test_tasks.py       # Task CRUD endpoint tests
â”‚   â””â”€â”€ test_auth.py        # Authentication tests
â”‚
â”œâ”€â”€ alembic/                # Database migrations
â”‚   â”œâ”€â”€ versions/
â”‚   â”‚   â””â”€â”€ 001_initial_schema.py
â”‚   â””â”€â”€ env.py
â”‚
â”œâ”€â”€ Dockerfile              # Backend container
â”œâ”€â”€ requirements.txt        # Production dependencies
â”œâ”€â”€ requirements-dev.txt    # Development dependencies
â””â”€â”€ .env.example            # Environment variable template

# Phase II: Frontend (Next.js)
frontend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (auth)/             # Public auth routes
â”‚   â”‚   â”œâ”€â”€ signin/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx    # Sign in page
â”‚   â”‚   â””â”€â”€ signup/
â”‚   â”‚       â””â”€â”€ page.tsx    # Sign up page
â”‚   â”‚
â”‚   â”œâ”€â”€ (app)/              # Protected app routes
â”‚   â”‚   â”œâ”€â”€ layout.tsx      # App layout with auth guard
â”‚   â”‚   â””â”€â”€ tasks/
â”‚   â”‚       â”œâ”€â”€ page.tsx    # Task list page
â”‚   â”‚       â”œâ”€â”€ [id]/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx # Task detail/edit page
â”‚   â”‚       â””â”€â”€ new/
â”‚   â”‚           â””â”€â”€ page.tsx # Create task page
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                # API routes (Better Auth handler)
â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”‚       â””â”€â”€ [...all]/
â”‚   â”‚           â””â”€â”€ route.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ layout.tsx          # Root layout
â”‚   â””â”€â”€ page.tsx            # Landing page
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/                 # Reusable UI components
â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”œâ”€â”€ input.tsx
â”‚   â”‚   â”œâ”€â”€ card.tsx
â”‚   â”‚   â””â”€â”€ dialog.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ tasks/              # Task-specific components
â”‚   â”‚   â”œâ”€â”€ task-list.tsx
â”‚   â”‚   â”œâ”€â”€ task-item.tsx
â”‚   â”‚   â”œâ”€â”€ task-form.tsx
â”‚   â”‚   â””â”€â”€ task-filters.tsx
â”‚   â”‚
â”‚   â””â”€â”€ auth/               # Auth components
â”‚       â”œâ”€â”€ signin-form.tsx
â”‚       â”œâ”€â”€ signup-form.tsx
â”‚       â””â”€â”€ auth-guard.tsx
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ api.ts              # API client with JWT injection
â”‚   â”œâ”€â”€ auth.ts             # Better Auth configuration
â”‚   â””â”€â”€ utils.ts            # Utility functions
â”‚
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ task.ts             # Task TypeScript interfaces
â”‚   â””â”€â”€ user.ts             # User TypeScript interfaces
â”‚
â”œâ”€â”€ __tests__/              # Frontend tests
â”‚   â”œâ”€â”€ components/
â”‚   â””â”€â”€ lib/
â”‚
â”œâ”€â”€ public/                 # Static assets
â”œâ”€â”€ Dockerfile              # Frontend container
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tailwind.config.ts
â”œâ”€â”€ next.config.js
â””â”€â”€ .env.local.example

# Phase II: Docker Compose
docker-compose.yml          # Development environment
docker-compose.prod.yml     # Production environment
.env.example                # Root environment template
```

**Structure Decision**: Web application structure with separate backend/ and frontend/ directories. The src/ directory from Phase I is preserved as a reference implementation. This follows the monorepo pattern specified in the constitution with clear separation between presentation (Next.js), business logic (FastAPI), and data (Neon PostgreSQL).

## Complexity Tracking

> **No violations requiring justification**

All architectural decisions align with constitutional principles:
- Stateless backend design enables horizontal scaling
- Clean layer separation (Frontend â†’ API â†’ Database)
- User isolation enforced at database query level
- JWT authentication following security mandates
- SQLModel ORM preventing SQL injection
- Better Auth handling password security
- Spec-driven development process maintained

---

## Phase 0: Research & Technology Decisions

**Objective**: Resolve all technical unknowns and establish best practices for implementation.

### Research Tasks

1. **Better Auth + Next.js 16 Integration**
   - Research: Better Auth setup with Next.js App Router
   - Output: Configuration patterns, API route setup, client-side integration

2. **Better Auth + FastAPI JWT Verification**
   - Research: JWT token verification in FastAPI
   - Output: Shared secret configuration, middleware implementation

3. **SQLModel with Neon PostgreSQL**
   - Research: Async SQLModel with PostgreSQL
   - Output: Connection pooling, session management, Alembic integration

4. **Alembic Migrations with SQLModel**
   - Research: Schema migration patterns
   - Output: Migration workflow, version control strategy

5. **Next.js App Router Best Practices**
   - Research: Server Components vs Client Components
   - Output: When to use each, data fetching patterns

6. **User Isolation at Database Level**
   - Research: Query filtering patterns
   - Output: Middleware implementation, SQL query patterns

7. **Deployment Strategy**
   - Research: Vercel (frontend) + backend hosting options
   - Output: Deployment configuration, environment variables

**Output**: `research.md` (to be created next)

---

## Phase 1: Design & Contracts

**Prerequisites**: `research.md` complete

### Deliverables

1. **data-model.md**
   - Entity: User (id, email, name, emailVerified, createdAt, updatedAt)
   - Entity: Task (id, userId, title, description, completed, createdAt, updatedAt)
   - Relationships: User 1:N Tasks (cascade delete)
   - Validation rules: Title 1-200 chars, description max 1000 chars
   - Indexes: userId, completed, createdAt

2. **contracts/rest-api.yaml**
   - OpenAPI 3.0 specification
   - Authentication endpoints: POST /auth/signup, POST /auth/signin
   - Task endpoints: GET/POST /api/tasks, GET/PUT/DELETE /api/tasks/{id}, PATCH /api/tasks/{id}/complete
   - Request/response schemas
   - Error response formats

3. **contracts/database-schema.sql**
   - SQL DDL for users table (Better Auth managed)
   - SQL DDL for tasks table
   - Foreign key constraints
   - Indexes
   - Triggers (if needed)

4. **quickstart.md**
   - Environment setup instructions
   - Database configuration (Neon)
   - Backend setup (FastAPI)
   - Frontend setup (Next.js)
   - Running tests
   - Docker Compose workflow

**Output**: Above files created in this phase

---

## Implementation Phases

### Phase 2: Task Breakdown (via /speckit.tasks)
- Break down implementation into atomic tasks
- Order by dependency
- Estimate complexity
- **Command**: `/speckit.tasks`
- **Output**: `tasks.md`

### Phase 3: Implementation (via Claude Code)
- Execute tasks sequentially
- Generate code from specs
- Write tests (>80% coverage)
- **Process**: Spec-driven code generation

### Phase 4: Validation & Deployment
- Run all tests
- Verify acceptance criteria
- Deploy to staging
- User acceptance testing

---

## Risk Assessment

### High Risk
1. **Better Auth + FastAPI Integration**: Potential issues with JWT secret sharing
   - **Mitigation**: Use environment variables, test token verification early

2. **User Isolation**: Risk of data leakage between users
   - **Mitigation**: Implement and test user_id filtering in all queries

3. **Async SQLModel Complexity**: Complex async patterns
   - **Mitigation**: Follow established patterns from research phase

### Medium Risk
1. **Neon PostgreSQL Connection Pooling**: Configuration complexity
   - **Mitigation**: Use recommended asyncpg settings

2. **Next.js App Router Learning Curve**: New paradigm
   - **Mitigation**: Research Server vs Client Components thoroughly

3. **Deployment Configuration**: Environment variable management
   - **Mitigation**: Document all required variables, use .env.example

### Low Risk
1. **Task CRUD Logic**: Well-understood from Phase I
   - **Mitigation**: Port existing validation logic

2. **UI Components**: Standard patterns
   - **Mitigation**: Use Tailwind CSS, shadcn/ui components

---

## Dependencies & Integration Points

### External Dependencies
- **Neon PostgreSQL**: Database hosting
- **Better Auth**: User authentication
- **Vercel**: Frontend hosting (optional)
- **OpenAI/Anthropic**: Spec-driven code generation via Claude Code

### Internal Dependencies
- **Phase I Business Logic**: Reference for validation rules
- **Spec-Kit Plus**: Planning and task management
- **Docker**: Containerization for development

### Integration Points
1. **Frontend â†” Backend**: REST API over HTTP/JSON
2. **Backend â†” Database**: SQLModel ORM with async PostgreSQL
3. **Frontend â†” Better Auth**: Session management and JWT tokens
4. **Backend â†” Better Auth**: JWT verification with shared secret

---

## Success Criteria

### Functional
- [ ] User can sign up with email/password
- [ ] User can sign in and receive JWT token
- [ ] User can create tasks (saved to database)
- [ ] User can view only their own tasks
- [ ] User can update task title/description
- [ ] User can delete tasks with confirmation
- [ ] User can toggle task completion status
- [ ] Data persists across browser sessions
- [ ] Multi-user isolation verified (no cross-user data leakage)

### Technical
- [ ] >80% test coverage (backend)
- [ ] No TypeScript errors (frontend)
- [ ] No Python linting errors (backend)
- [ ] All API endpoints return correct status codes
- [ ] All queries filtered by user_id
- [ ] JWT tokens validated on every request
- [ ] Mobile-responsive UI
- [ ] Loading states on all async operations
- [ ] Error handling with user-friendly messages

### Security
- [ ] Passwords hashed via Better Auth (bcrypt)
- [ ] JWT tokens signed with HS256
- [ ] CORS restricted to frontend origin
- [ ] SQL injection prevention (SQLModel)
- [ ] User isolation enforced
- [ ] No secrets in version control

### Performance
- [ ] API response time <200ms (p95)
- [ ] Initial page load <2 seconds
- [ ] Database queries optimized (indexes used)
- [ ] Connection pooling configured

---

## Next Steps

1. âœ… **Plan Created**: This file
2. ðŸ”„ **Phase 0**: Create `research.md` (next action)
3. ðŸ”„ **Phase 1**: Create design artifacts (data-model.md, contracts/, quickstart.md)
4. â³ **Phase 2**: Generate `tasks.md` via `/speckit.tasks` command
5. â³ **Phase 3**: Implement via Claude Code
6. â³ **Phase 4**: Test, validate, deploy

---

**Plan Status**: âœ… Complete (pending research and design phases)
**Generated**: December 28, 2024
**By**: Claude Code (Sonnet 4.5)
